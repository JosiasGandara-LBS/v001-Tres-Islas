import{a as M}from"./chunk-SUIUQCOZ.js";import{Ad as p,B as v,Cd as f,Dd as x,Fd as I,Hd as T,R as w,U as g,_ as u,a as b,ab as l,m as C,ma as j,rc as h,wa as y}from"./chunk-UBYFVHHT.js";function S(i,m){let e=!m?.manualCleanup;e&&!m?.injector&&j(S);let t=e?m?.injector?.get(y)??u(y):null,r;m?.requireSync?r=l({kind:0}):r=l({kind:1,value:m?.initialValue});let s=i.subscribe({next:o=>r.set({kind:1,value:o}),error:o=>{if(m?.rejectErrors)throw o;r.set({kind:2,error:o})}});return t?.onDestroy(s.unsubscribe.bind(s)),h(()=>{let o=r();switch(o.kind){case 1:return o.value;case 2:throw o.error;case 0:throw new w(601,"`toSignal()` called with `requireSync` but `Observable` did not emit synchronously.")}})}var D=(()=>{class i{constructor(){this.firestore=u(p),this._promotionCollection=I(this.firestore,"promotions"),this.promotions=[],this.promotionsSubject=new C([]),this.promotions$=this.promotionsSubject.asObservable(),this.loadPromotions(),this.startTimer()}loadPromotions(){f(this._promotionCollection,{idField:"id"}).subscribe(e=>{this.promotions=e,this.filterPromotions()})}startTimer(){v(1e4).subscribe(()=>this.filterPromotions())}filterPromotions(){let e=new Date,t=e.getHours().toString().padStart(2,"0")+":"+e.getMinutes().toString().padStart(2,"0"),r=this.promotions.filter(s=>s.enabled&&s.startTime<=t&&s.endTime>=t);console.log("Hora actual:",t,"Promociones activas:",r),this.promotionsSubject.next(r)}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=g({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var Y=(()=>{class i{constructor(){this._firestore=u(p),this._storage=u(M),this._collectionMenu=I(this._firestore,"menu"),this.promotions2Service=u(D),this.cartItemsCount=l(0),this.cartItems=l([]),this.cartItemsSignal=l(this.getCartItems()),this.promotionsSignal=l([]),this.totalPrice=h(()=>{let e=this.cartItemsSignal(),t=this.promotionsSignal(),r=0,s=new Map;return t.forEach(o=>{o.enabled&&o.categories.forEach(n=>s.set(n,o))}),r=e.reduce((o,n)=>{let a=n.quantity,c=n.price,d=s.get(n.category);return d&&(a=this.applyPromotion(d,a,c)),o+c*a},0),r}),this.getMenu=S(f(this._collectionMenu,{idField:"id"}),{initialValue:[]}),this.cartItems.set(this.getCartItems()),this.cartItemsCount.set(this.getTotalItems()),this.cartItemsSignal.set(this.getCartItems()),this.promotions2Service.promotions$.subscribe(e=>{this.promotionsSignal.set(e)})}get cartItemsValue(){return this.cartItems()}getCartItemsCount(){return h(()=>this.cartItemsCount())}getTotalPriceSignal(){return this.totalPrice}getPromotionsSignal(){return this.promotionsSignal}getItemById(e){let t=T(this._firestore,`menu/${e}`);return x(t,{idField:"id"})}getTotalItems(){return this.getCartItems().reduce((t,r)=>t+r.quantity,0)}getTotalPrice(){let e=this.getCartItems(),t=0;return this.promotions2Service.promotions$.subscribe(r=>{let s=new Map;r.forEach(o=>{o.enabled&&o.categories.forEach(n=>s.set(n,o))}),t=e.reduce((o,n)=>{let a=n.quantity,c=n.price,d=s.get(n.category);return d&&(a=this.applyPromotion(d,a,c)),o+c*a},0),console.log("Total con promociones aplicadas:",t)}),t}applyPromotion(e,t,r){switch(e.id){case"3X2TYT3A5":let s=Math.floor(t/3);t-=s;break;case"TEST50OFF":t=Math.ceil(t*.5);break;case"TEST2X1":t-=Math.floor(t/2);break;default:console.log(`No hay reglas definidas para la promo: ${e.id}`)}return t}getCartItems(){let e=localStorage.getItem("cart");return e?JSON.parse(e):[]}getCartItemById(e){return this.getCartItems().find(r=>r.id===e)}getCartItemsToOrder(){return JSON.parse(localStorage.getItem("cart")||"[]").map(t=>({id:t.id,name:t.name,quantity:t.quantity,category:t.category,price:t.price,additionalInstructions:t.additionalInstructions}))}getQuantity(e){return this.getCartItems().filter(r=>r.id===e).reduce((r,s)=>r+s.quantity,0)}saveCartItems(e){localStorage.setItem("cart",JSON.stringify(e)),this.cartItems.set(e),this.cartItemsSignal.set(e),this.cartItemsCount.set(this.getTotalItems())}addToCart(e,t,r,s,o,n,a){let c=[...this.cartItems()];c.push({id:e,name:t,description:r,category:s,price:o,image:"",quantity:n,additionalInstructions:a}),this.saveCartItems(c)}updateCartItemsWithImage(){let e=this.getMenu(),t=this.cartItemsValue;t.forEach(r=>{let s=e.find(o=>o.id===r.id);s&&(r.image=s.image)}),this.saveCartItems(t)}updateCartItem(e){let t=this.getCartItems(),r=t.findIndex(s=>s.id===e.id);r!==-1&&(t[r]=b(b({},t[r]),e),this.saveCartItems(t))}deleteCartItem(e){let t=this.getCartItems(),r=t.findIndex(s=>s.id===e);r!==-1&&(t.splice(r,1),this.saveCartItems(t))}clearCart(){localStorage.removeItem("cart"),this.cartItems.set([]),this.cartItemsCount.set(0)}incrementQuantity(e){let t=this.getCartItems(),r=t.find(s=>s.id===e);r&&(r.quantity+=1,this.saveCartItems(t))}decrementQuantity(e){let t=this.getCartItems(),r=t.find(s=>s.id===e);if(r){if(r.quantity=Math.max(0,r.quantity-1),r.quantity===0){let s=t.indexOf(r);s>-1&&t.splice(s,1)}this.saveCartItems(t)}}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=g({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();export{D as a,Y as b};
