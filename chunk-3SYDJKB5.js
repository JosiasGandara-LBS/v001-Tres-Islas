import{c as p}from"./chunk-NUVXZR4T.js";import{a as T}from"./chunk-SQKWSB3T.js";import{Ad as A,Hd as a,Id as c,U as f,_ as n,a as d,ab as g,b as h,e as D,f as s,od as w,pd as I,qd as v,td as y}from"./chunk-NPZE2FBW.js";var u=D(T());var j=(()=>{class i{constructor(){this._firestore=n(A),this._router=n(p),this.Auth=n(v),this.auth=I(),this.user$=y(this.Auth),this.user=g(void 0),this.Auth.onAuthStateChanged(e=>{e?this.actualizarUsuario(e):this.user.set(null)})}login(e,t){return s(this,null,function*(){try{let r=(yield w(this.Auth,e,t)).user,l=yield r.getIdToken();localStorage.setItem("accessToken",l),yield this.actualizarUsuario(r),u.default.fire({icon:"success",title:"Inicio de sesi\xF3n correcto",text:"Bienvenido",showConfirmButton:!1,timer:1500}),yield new Promise(k=>setTimeout(k,1e3));let m=this.user()?.role;return m==="ADMIN"||m==="TI"?this._router.navigate(["/admin"]):this._router.navigate(["/orders-waiter"]),!0}catch(o){return console.error("Authentication failed:",o),u.default.fire({icon:"error",title:"Inicio de sesi\xF3n incorrecto",text:"Usuario o contrase\xF1a incorrectos",showConfirmButton:!1,timer:1500}),!1}})}logout(){this.user.set(null),this.auth.signOut(),localStorage.removeItem("accessToken"),this._router.navigate(["/login"])}getRole(){return this.user()?.role}setRole(){return s(this,null,function*(){let e=this.user();if(e){let t=a(this._firestore,`employees/${e.uid}`),o=yield c(t);o.exists()&&this.user.set(h(d({},e),{name:o.get("name"),role:o.get("role")}))}})}getNavItems(){let e=this.getRole();return e==="ADMIN"||e==="TI"?[{name:"Pedidos",route:"orders-waiter",icon:"pi-list"},{name:"Productos",route:"products",icon:"pi-box"},{name:"Usuarios",route:"employees",icon:"pi-user"},{name:"Historial",route:"history",icon:"pi-clock"},{name:"Configuraciones",route:"configs",icon:"pi-cog"}]:e==="CAJA"?[{name:"Pedidos",route:"orders-waiter",icon:"pi-list"},{name:"Productos",route:"products",icon:"pi-box"}]:[{name:"Pedidos",route:"orders-waiter",icon:"pi-list"}]}validateToken(e){return s(this,null,function*(){let t=this.decodeToken(e);if(!t)return localStorage.removeItem("accessToken"),this._router.navigate(["/login"]),!1;if(t.exp<Date.now()/1e3)return localStorage.removeItem("accessToken"),this._router.navigate(["/login"]),!1;let o=a(this._firestore,`employees/${t.user_id}`),r=yield c(o);return r.exists()?(this.user.set({uid:t.user_id,email:t.email,name:r.get("name"),role:r.get("role")}),!0):(localStorage.removeItem("accessToken"),this._router.navigate(["/login"]),!1)})}decodeToken(e){try{let o=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),r=decodeURIComponent(window.atob(o).split("").map(l=>"%"+("00"+l.charCodeAt(0).toString(16)).slice(-2)).join(""));return JSON.parse(r)}catch(t){return console.error("Error decoding token:",t),null}}actualizarUsuario(e){return s(this,null,function*(){let t=a(this._firestore,`employees/${e.uid}`),o=yield c(t);o.exists()?this.user.set({uid:e.uid,email:e.email,name:o.get("name"),role:o.get("role")}):(u.default.fire({icon:"error",title:"Error de autenticaci\xF3n",text:"No se encontraron datos de usuario",showConfirmButton:!1,timer:1500}),this.logout())})}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=f({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();export{j as a};
