import{a as T}from"./chunk-ZPYXFHOM.js";import{B as w,Bd as g,Dd as p,Ed as D,Gd as b,Id as P,R as j,U as f,_ as l,a as y,ab as u,m as v,ma as x,rc as h,sc as I,wa as S}from"./chunk-NAS4OXTP.js";function C(n,m){let e=!m?.manualCleanup;e&&!m?.injector&&x(C);let t=e?m?.injector?.get(S)??l(S):null,i;m?.requireSync?i=u({kind:0}):i=u({kind:1,value:m?.initialValue});let s=n.subscribe({next:r=>i.set({kind:1,value:r}),error:r=>{if(m?.rejectErrors)throw r;i.set({kind:2,error:r})}});return t?.onDestroy(s.unsubscribe.bind(s)),h(()=>{let r=i();switch(r.kind){case 1:return r.value;case 2:throw r.error;case 0:throw new j(601,"`toSignal()` called with `requireSync` but `Observable` did not emit synchronously.")}})}var M=(()=>{class n{constructor(){this.firestore=l(g),this._promotionCollection=b(this.firestore,"promotions"),this.promotions=[],this.promotionsSubject=new v([]),this.promotions$=this.promotionsSubject.asObservable(),this.loadPromotions(),this.startTimer()}loadPromotions(){p(this._promotionCollection,{idField:"id"}).subscribe(e=>{this.promotions=e,this.filterPromotions()})}startTimer(){w(1e4).subscribe(()=>this.filterPromotions())}filterPromotions(){let e=new Date,t=e.getHours().toString().padStart(2,"0")+":"+e.getMinutes().toString().padStart(2,"0"),i=[];this.promotions.forEach(s=>{s.startTime<=t&&s.endTime>=t||(s.enabled=!1),i.push(s)}),this.promotionsSubject.next(i)}static{this.\u0275fac=function(t){return new(t||n)}}static{this.\u0275prov=f({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();var z=(()=>{class n{constructor(){this._firestore=l(g),this._storage=l(T),this._collectionMenu=b(this._firestore,"menu"),this.promotions2Service=l(M),this.cartItemsCount=u(0),this.cartItems=u([]),this.cartItemsSignal=u(this.getCartItems()),this.promotionsSignal=u([]),this.arePromotionsActive=u(!1),this.cartItemsWithDiscount=u([]),this.modalVisible=u(!1),this.totalPrice=h(()=>{let e=this.promotionsSignal(),t=0,i=new Map;return e.forEach(s=>{s.enabled&&s.categories.forEach(r=>i.set(r,s))}),t=this.cartItemsWithDiscount().reduce((s,r)=>{let o=r.quantity,a=r.price,c=r.discounted||0;return s+(a*o-c)},0),t}),this.getMenu=C(p(this._collectionMenu,{idField:"id"}),{initialValue:[]}),this.cartItems.set(this.getCartItems()),this.cartItemsCount.set(this.getTotalItems()),this.cartItemsSignal.set(this.getCartItems()),this.promotions2Service.promotions$.subscribe(e=>{this.promotionsSignal.set(e)}),I(()=>{let e=this.cartItems(),t=this.promotionsSignal();if(!t.length)return;let i=e.some(r=>t.some(o=>o.enabled&&o.categories.includes(r.category)));e.some(r=>r.discounted>0&&!i)&&this.modalVisible.set(!0)},{allowSignalWrites:!0}),I(()=>{let e=this.cartItems();e.forEach(s=>{s.discounted=0});let t=e.filter(s=>this.hasPromotion(s)).sort((s,r)=>s.price-r.price);if(t.length>0){let s=t.reduce((o,a)=>o+a.quantity,0),r=Math.floor(s/3);for(let o=0;o<r;o++)for(let a=0;a<t.length;a++){let c=t[a];if(c.quantity*c.price>(c.discounted||0)){t[a].discounted=(c.discounted||0)+c.price;break}}}let i=e.map(s=>{let r=t.find(o=>o.id===s.id);return r&&(s.discounted=r.discounted),s});this.cartItemsWithDiscount.set(i)},{allowSignalWrites:!0})}hasPromotion(e){return this.promotionsSignal().some(t=>t.enabled&&t.categories.includes(e.category))}get cartItemsValue(){return this.cartItems()}getCartItemsCount(){return h(()=>this.cartItemsCount())}getTotalPriceSignal(){return this.totalPrice}getPromotionsSignal(){return this.promotionsSignal}getItemById(e){let t=P(this._firestore,`menu/${e}`);return D(t,{idField:"id"})}getTotalItems(){return this.getCartItems().reduce((t,i)=>t+i.quantity,0)}getTotalPrice(){let e=this.getCartItems(),t=0;return this.promotions2Service.promotions$.subscribe(i=>{let s=new Map;i.forEach(r=>{r.enabled&&r.categories.forEach(o=>s.set(o,r))}),t=e.reduce((r,o)=>{let a=o.quantity,c=o.price,d=o.discounted||0;return r+(c*a-d)},0)}),t}applyPromotion(e,t,i){switch(e.id){case"3X2TYT3A5":let s=Math.floor(t/3);t-=s;break;case"TEST50OFF":t=Math.ceil(t*.5);break;case"TEST2X1":t-=Math.floor(t/2);break;default:console.error(`No hay reglas definidas para la promo: ${e.id}`)}return t}getCartItems(){let e=localStorage.getItem("cart");return e?JSON.parse(e):[]}getCartItemById(e){return this.getCartItems().find(i=>i.id===e)}getCartItemsToOrder(){return JSON.parse(localStorage.getItem("cart")||"[]").map(t=>({id:t.id,name:t.name,quantity:t.quantity,category:t.category,price:t.price,discount:t.discount||0,additionalInstructions:t.additionalInstructions}))}getQuantity(e){return this.getCartItems().filter(i=>i.id===e).reduce((i,s)=>i+s.quantity,0)}getAdditionalInstructionsById(e){let i=this.getCartItems().find(s=>s.id===e);return i?i.additionalInstructions:""}saveCartItems(e){localStorage.setItem("cart",JSON.stringify(e)),this.cartItems.set(e),this.cartItemsSignal.set(e),this.cartItemsCount.set(this.getTotalItems())}addToCart(e,t,i,s,r,o,a){let c=[...this.cartItems()],d=c.find(k=>k.id===e);d?(d.quantity+=o,d.additionalInstructions=a):c.push({id:e,name:t,description:i,category:s,price:r,image:"",quantity:o,additionalInstructions:a,discount:0}),this.saveCartItems(c)}updateCartItemsWithImage(){let e=this.getMenu(),t=this.cartItemsValue;t.forEach(i=>{let s=e.find(r=>r.id===i.id);s&&(i.image=s.image)}),this.saveCartItems(t)}updateCartItem(e){let t=this.getCartItems(),i=t.findIndex(s=>s.id===e.id);i!==-1&&(t[i]=y(y({},t[i]),e),this.saveCartItems(t))}deleteCartItem(e){let t=this.getCartItems(),i=t.findIndex(s=>s.id===e);i!==-1&&(t.splice(i,1),this.saveCartItems(t))}clearCart(){localStorage.removeItem("cart"),this.cartItems.set([]),this.cartItemsCount.set(0)}incrementQuantity(e){let t=this.getCartItems(),i=t.find(s=>s.id===e);i&&(i.quantity+=1,this.saveCartItems(t))}decrementQuantity(e){let t=this.getCartItems(),i=t.find(s=>s.id===e);if(i){if(i.quantity=Math.max(0,i.quantity-1),i.quantity===0){let s=t.indexOf(i);s>-1&&t.splice(s,1)}this.saveCartItems(t)}}static{this.\u0275fac=function(t){return new(t||n)}}static{this.\u0275prov=f({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();export{M as a,z as b};
